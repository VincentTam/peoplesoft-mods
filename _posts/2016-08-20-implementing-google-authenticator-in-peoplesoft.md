---
id: 545
title: Implementing Google Authenticator in PeopleSoft
date: 2016-08-20T17:00:28+00:00
guid: http://www.peoplesoftmods.com/?p=545
permalink: /2fa/implementing-google-authenticator-in-peoplesoft/
categories:
  - Two-Factor Authentication
---
I [previously demonstrated](http://www.peoplesoftmods.com/2fa/google-authenticator-in-peoplesoft/) how I use Google Authenticator to protect sensitive resources in my PeopleSoft applications.  I would like to share the code involved to get this to work.  If you are unfamiliar with what Google Authenticator is and how it works, then I suggest <a href="https://en.wikipedia.org/wiki/Google_Authenticator" target="_blank">reading about it here</a>.  A while back, I read a <a href="http://thegreyblog.blogspot.com/2011/12/google-authenticator-using-it-in-your.html" target="_blank">nice article</a> that demonstrated a simple Java implementation of the Time-based One-time Password (TOTP) algorithm (specified in <a href="http://tools.ietf.org/html/rfc6238" target="_blank">RFC 6238</a>) that is used with Google Authenticator. After making slight modifications to the code, I was able to easily integrate this Java implementation in my PeopleSoft application. I packaged the code up into a JAR file that I will explain how to use in this post. **UPDATE**:  I recently discovered that there are some other mobile applications that implement the same TOTP algorithm as Google Authenticator. Some examples of these applications are Duo, Authy, and even Oracle Mobile Authenticator.  This means that any of these other TOTP-generating applications can be used with the solution that I am demonstrating in this tutorial.

<!--more-->

<span style="text-decoration: underline;"><strong><a href="http://www.peoplesoftmods.com/Development/psGAuth.jar">CLICK HERE</a></strong></span> to download the JAR file

The downloaded JAR file will need to be placed on to the PeopleSoft app server.  Specifically, the JAR file needs to reside in the class directory of the your PS_HOME.  The JAR file path should look like this:

_%PS_HOME%\class\psGAuth.jar_

An app server bounce and cache clear needs to be performed after adding the JAR file to the app server.

I will first discuss the defined Java methods that will be invoked from the PeopleCode.

  * GetKey()

This method returns a random, 32 character, base 32 encoded string.  This is the secret key that will be shared between the PeopleSoft application and the client&#8217;s Google Authenticator application.  This method will be invoked for users that have net yet set up the Google Authenticator application.

  * CheckCode (string SecretKey, integer Code, integer Timestamp)

This method is used to check if a given TOTP is valid for a particular user at a particular time. The SecretKey parameter is the shared secret key that was produced from the GetKey method during the user’s initial Google Authenticator setup.  The Code parameter is the TOTP (six digit number) generated by the user’s Google Authenticator application.  The Timestamp parameter is the PeopleSoft application’s Unix timestamp divided by 30.  This method will return a Boolean value that will signify if the user inputted TOTP is a valid one.

Now I will give a technical demonstration of how you can use the two-step verification process in your PeopleSoft applications.

The PeopleCode that will need to be written first is the code that is capable of creating a new Google Authenticator account in the system for a given user.  I put the code behind a push button on a setup page:

<img class="alignnone wp-image-585 size-full" src="http://www.peoplesoftmods.com/wp-content/uploads/2016/08/NewUser.png" alt="NewUser" width="582" height="167" srcset="http://www.peoplesoftmods.com/wp-content/uploads/2016/08/NewUser.png 582w, http://www.peoplesoftmods.com/wp-content/uploads/2016/08/NewUser-300x86.png 300w" sizes="(max-width: 582px) 100vw, 582px" />

The code behind the button will call the GetKey method to create the shared secret key.

<img class="alignnone wp-image-586 size-full" src="http://www.peoplesoftmods.com/wp-content/uploads/2016/08/GetKey.png" alt="GetKey" width="437" height="119" srcset="http://www.peoplesoftmods.com/wp-content/uploads/2016/08/GetKey.png 437w, http://www.peoplesoftmods.com/wp-content/uploads/2016/08/GetKey-300x82.png 300w" sizes="(max-width: 437px) 100vw, 437px" />

Once you obtain the secret key, you will need to generate a QR code so that the user can easily import the account information into their Google Authenticator app.  You do not necessarily have to create a QR code, it just makes it easier on the user from not having to manually type in the secret key into the app.  I make use of the <a href="https://developers.google.com/chart/" target="_blank">Google Charts API</a> to generate the QR code.

<img class="alignnone wp-image-587 size-full" src="http://www.peoplesoftmods.com/wp-content/uploads/2016/08/QRURL.png" alt="QRURL" width="612" height="105" srcset="http://www.peoplesoftmods.com/wp-content/uploads/2016/08/QRURL.png 612w, http://www.peoplesoftmods.com/wp-content/uploads/2016/08/QRURL-300x51.png 300w" sizes="(max-width: 612px) 100vw, 612px" />

Once I have the URL to the QR code, I display it in an html area.

<img class="alignnone wp-image-588 size-full" src="http://www.peoplesoftmods.com/wp-content/uploads/2016/08/DisplayQRCode.png" alt="DisplayQRCode" width="526" height="64" srcset="http://www.peoplesoftmods.com/wp-content/uploads/2016/08/DisplayQRCode.png 526w, http://www.peoplesoftmods.com/wp-content/uploads/2016/08/DisplayQRCode-300x37.png 300w" sizes="(max-width: 526px) 100vw, 526px" />

This QR code is displayed in a setup page for the user.

<img class="alignnone wp-image-589 size-full" src="http://www.peoplesoftmods.com/wp-content/uploads/2016/08/5cSetupGAuth.png" alt="SetupGAuth" width="331" height="525" srcset="http://www.peoplesoftmods.com/wp-content/uploads/2016/08/5cSetupGAuth.png 331w, http://www.peoplesoftmods.com/wp-content/uploads/2016/08/5cSetupGAuth-189x300.png 189w, http://www.peoplesoftmods.com/wp-content/uploads/2016/08/5cSetupGAuth-240x380.png 240w" sizes="(max-width: 331px) 100vw, 331px" />

At this point, the user can open up their Google Authenticator app and scan the QR code (or manually input the account information) to add their new account.

<img class="alignnone wp-image-580" src="http://www.peoplesoftmods.com/wp-content/uploads/2016/08/PhoneScreen1-1.png" alt="PhoneScreen1" width="270" height="527" srcset="http://www.peoplesoftmods.com/wp-content/uploads/2016/08/PhoneScreen1-1.png 334w, http://www.peoplesoftmods.com/wp-content/uploads/2016/08/PhoneScreen1-1-154x300.png 154w, http://www.peoplesoftmods.com/wp-content/uploads/2016/08/PhoneScreen1-1-195x380.png 195w" sizes="(max-width: 270px) 100vw, 270px" />

After scanning the QR code, the application will start generating TOTPs immediately.

<img class="alignnone wp-image-582" src="http://www.peoplesoftmods.com/wp-content/uploads/2016/08/PhoneScreen2.png" alt="PhoneScreen2" width="271" height="529" srcset="http://www.peoplesoftmods.com/wp-content/uploads/2016/08/PhoneScreen2.png 334w, http://www.peoplesoftmods.com/wp-content/uploads/2016/08/PhoneScreen2-154x300.png 154w, http://www.peoplesoftmods.com/wp-content/uploads/2016/08/PhoneScreen2-195x380.png 195w" sizes="(max-width: 271px) 100vw, 271px" />

Now the user can input the generated TOTP into the prompt to ensure that their application is working correctly.

<img class="alignnone wp-image-590 size-full" src="http://www.peoplesoftmods.com/wp-content/uploads/2016/08/InputCode.png" alt="InputCode" width="281" height="129" />

The code behind the “OK” button will call the CheckCode method to determine if the inputted code is correct.

<img class="alignnone wp-image-591 size-full" src="http://www.peoplesoftmods.com/wp-content/uploads/2016/08/CheckCode.png" alt="CheckCode" width="810" height="225" srcset="http://www.peoplesoftmods.com/wp-content/uploads/2016/08/CheckCode.png 810w, http://www.peoplesoftmods.com/wp-content/uploads/2016/08/CheckCode-300x83.png 300w, http://www.peoplesoftmods.com/wp-content/uploads/2016/08/CheckCode-768x213.png 768w" sizes="(max-width: 810px) 100vw, 810px" />

If the CheckCode method returns true, then the user’s account information will be stored into the database.  In this demonstration, I am storing the User ID and the secret key value in the clear.  It would be a good idea to store the secret key in an encrypted state.

<img class="alignnone wp-image-592 size-full" src="http://www.peoplesoftmods.com/wp-content/uploads/2016/08/GAuthTable.png" alt="GAuthTable" width="338" height="105" srcset="http://www.peoplesoftmods.com/wp-content/uploads/2016/08/GAuthTable.png 338w, http://www.peoplesoftmods.com/wp-content/uploads/2016/08/GAuthTable-300x93.png 300w" sizes="(max-width: 338px) 100vw, 338px" />

Now that you see how a new user gets set up with Google Authenticator, I would like to show you how you can present the two-step verification challenge in your application.  When a user attempts to access a resource that you would like to protect with two-step verification, you will need to ensure that you have a secret key stored in the database for the user.

<img class="alignnone wp-image-594 size-full" src="http://www.peoplesoftmods.com/wp-content/uploads/2016/08/CheckUser.png" alt="CheckUser" width="674" height="91" srcset="http://www.peoplesoftmods.com/wp-content/uploads/2016/08/CheckUser.png 674w, http://www.peoplesoftmods.com/wp-content/uploads/2016/08/CheckUser-300x41.png 300w" sizes="(max-width: 674px) 100vw, 674px" />

If there is no secret key in the database for the user, then you will need to prompt the user to set up Google Authenticator as shown above.  Otherwise, you will need to prompt the user to input the current TOTP value that their Google Authenticator app has generated.

<img class="alignnone wp-image-593 size-full" src="http://www.peoplesoftmods.com/wp-content/uploads/2016/08/ChallengeUser.png" alt="ChallengeUser" width="590" height="184" srcset="http://www.peoplesoftmods.com/wp-content/uploads/2016/08/ChallengeUser.png 590w, http://www.peoplesoftmods.com/wp-content/uploads/2016/08/ChallengeUser-300x94.png 300w" sizes="(max-width: 590px) 100vw, 590px" />

The code behind the “OK” button is similar to the code above except the SecretKey parameter of the CheckCode method will be pulled from the database rather than being obtained from the GetKey method since the user already has an account setup.

If the user inputs the correct TOTP into the prompt, then you should redirect the user to the protected resource that they were originally trying to access.  You might want to consider storing a session cookie (or create a session variable) that will signify that the user has performed two-step verification for the session.  Tracking if the users have already performed two-step verification for the session will allow you to provide your users with a better experience by not making them perform two-step verification more than once a session.

<span style="color: #ff0000;">Some important things to note:</span>

<span style="color: #ff0000;">Ensure that the time on your server is correct and that the client’s time is in sync with your server.   There is room for about a minute difference in time, but anything more than that will cause the TOTPs to fail.</span>

* * *

The two-step verification process with Google Authenticator can be enforced anywhere you want in your PeopleSoft application.  One use case would be to do two-step verification at the login page.  You can simply add an additional field for the TOTP on the login page and validate the inputted value in the sign on PeopleCode.  While this may cause a negative impact on the user experience, there is nothing stopping you from doing this from a technical perspective.  Another use case would be to do the two-step verification at the component-level in PeopleSoft with event mapping as I did in [this video demonstration](http://www.peoplesoftmods.com/2fa/google-authenticator-in-peoplesoft/).

Future Plan #1:

I am currently polishing up (with plans of releasing) a solution to enforce the Google Authenticator challenge at the field-level in PeopleSoft.  This involved writing code on the web server to mask sensitive values and wrap the values in a clickable link. I previously demoed a (rough) version of this functionality [in this post](http://www.peoplesoftmods.com/servlet-filters/servlet-filters-in-peoplesoft/), but below is screenshot of what I am referring to.

<img class="alignnone wp-image-569 size-full" src="http://www.peoplesoftmods.com/wp-content/uploads/2016/08/11aFieldLevelChallenge.png" alt="FieldLevelChallenge" width="860" height="663" srcset="http://www.peoplesoftmods.com/wp-content/uploads/2016/08/11aFieldLevelChallenge.png 860w, http://www.peoplesoftmods.com/wp-content/uploads/2016/08/11aFieldLevelChallenge-300x231.png 300w, http://www.peoplesoftmods.com/wp-content/uploads/2016/08/11aFieldLevelChallenge-768x592.png 768w, http://www.peoplesoftmods.com/wp-content/uploads/2016/08/11aFieldLevelChallenge-493x380.png 493w" sizes="(max-width: 860px) 100vw, 860px" />

Clicking the lock icon will invoke a modal prompt to ask for a Google Authenticator TOTP.  If the user inputs a correct TOTP, then the sensitive value will be revealed.  I believe that enforcing the two-step verification in this manner is the most desirable way with respect to providing a good user experience.  However, implementing this particular solution is very challenging from a technical perspective.  Read [this post](http://www.peoplesoftmods.com/servlet-filters/how-to-set-up-a-data-masking-servlet-filter/) to learn how to achieve this type of field-level data masking solution.

Future Plan #2:

I am currently looking into leveraging the PeopleSoft Pluggable Encryption Technology (PET) to implement the TOTP algorithm natively within PeopleCode.  This way I will not have to rely on the Java code on the app server.

&nbsp;

If you have any questions, remarks, or problems with using Google Authenticator in your PeopleSoft applications, then feel free to leave me a comment and I will be more than glad to help you out.